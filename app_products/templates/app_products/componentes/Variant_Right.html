<!-- app_products/componentes/Variant_Right.html -->

{% load moneda %}
{% load static %}
{% load cart_filters %}

<!-- ================= INFORMACIÓN DEL PRODUCTO ================= -->

<!-- TÍTULO DEL PRODUCTO -->
<div class="mb-3">
    <h4 class="fw-bold text-dark mb-0">{{ product.name }}</h4>
</div>

<!-- ================= PRECIO ================= -->
<div id="priceContainer" class="mb-3">
    {% if main_variant %}
        {% if main_variant.discount_price %}
            <!-- Precio con descuento -->
            <div class="price-line mb-2">
                <span class="price-label me-2">Antes:</span> 
                <span class="price-old">
                    {{ main_variant.price|cop }}
                </span>
                {% if main_variant.discount_percentage > 0 %}
                    <span class="bg-danger text-white fw-bold px-2 py-1 rounded ms-2">
                        <small>-{{ main_variant.discount_percentage }}% OFF</small>
                    </span>
                {% endif %}
            </div>

            <div class="price-line">
                <span class="price-label me-2">Ahora:</span>
                <span class="price-new">
                    {{ main_variant.discount_price|cop }}
                </span>
            </div>
        {% else %}
            <!-- Precio regular -->
            <div class="price-line">
                <span class="price-label me-2">Precio:</span>
                <span class="price-new">
                    {{ main_variant.price|cop }}
                </span>
            </div>
        {% endif %}
    {% endif %}
</div>

<hr class="my-3">

<!-- ================= VARIANTES (Opciones con imágenes) ================= -->
{% if variants %}
<div class="mb-3">
    <label class="fw-bold mb-2 d-block">Opciones disponibles:</label>

    <div class="d-flex flex-wrap gap-2">
        {% for v in variants %}
            {% if v.images.first %}
                <div
                    class="variant-option border rounded p-2 text-center position-relative {% if v.stock == 0 %}variant-disabled{% endif %} {% if v.id == main_variant.id %}variant-selected{% endif %}"
                    data-variant-id="{{ v.id }}"
                    data-main-image="{{ v.images.first.image_url }}"
                    data-main-alt="{{ v.images.first.alt_text }}"
                    data-price="{{ v.price }}"
                    data-discount-price="{{ v.discount_price|default_if_none:'' }}"
                    data-discount-percentage="{{ v.discount_percentage }}"
                    data-stock="{{ v.stock }}"
                    data-images='[
                        {% for img in v.images.all %}
                            {"url":"{{ img.image_url }}","alt":"{{ img.alt_text|default:'' }}"}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ]'
                    data-options='[
                        {% for opt in v.options.all %}
                            {
                                "option":"{{ opt.option_value.option.name }}",
                                "value":"{{ opt.option_value.value }}"
                            }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ]'
                    {% if v.stock > 0 %}
                        onclick="selectVariantFromData(this)"
                    {% endif %}
                >
                    <img
                        src="{{ v.images.first.image_url }}"
                        alt="{{ v.images.first.alt_text }}"
                        class="img-fluid rounded mb-1"
                        style="height:50px; object-fit:cover;"
                    >

                    {% if v.stock == 0 %}
                        <small class="d-block text-danger fw-bold">Agotado</small>
                    {% else %}
                        <small class="d-block text-success fw-bold">
                            {% for opt in v.options.all %}
                                {% if opt.option_value.option.name == "Color" %}
                                    {{ opt.option_value.value }}
                                {% endif %}
                            {% endfor %}
                        </small>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<hr class="my-3">

<!-- ================= STOCK DISPONIBLE ================= -->
{% if main_variant %}
    <div id="stockInfo" class="mb-3">
        <div class="d-flex align-items-center gap-2 p-2 bg-light rounded">
            <i class="bi bi-box-seam text-primary"></i>
            <span class="fw-semibold small">Stock disponible:</span>
            <span id="stockValue" class="badge bg-primary px-2 py-1">{{ main_variant.stock }}</span>
        </div>
    </div>

    <!-- ================= SELECTOR DINÁMICO DE OPCIONES ================= -->

    <!-- MEDIDA -->
    {% if has_medida %}
    <div id="medidaContainer" class="mb-3">
        <label class="fw-bold d-block mb-2">Seleccionar medida:</label>
        <div id="medidaButtons" class="d-flex flex-wrap gap-2"></div>
    </div>
    {% endif %}

    <!-- PESO -->
    {% if has_peso %}
    <div id="pesoContainer" class="mb-3">
        <label class="fw-bold d-block mb-2">Seleccionar peso:</label>
        <div id="pesoButtons" class="d-flex flex-wrap gap-2"></div>
    </div>
    {% endif %}

    <!-- MATERIAL -->
    {% if has_material %}
    <div id="materialContainer" class="mb-3">
        <label class="fw-bold d-block mb-2">Seleccionar material:</label>
        <div id="materialButtons" class="d-flex flex-wrap gap-2"></div>
    </div>
    {% endif %}

    <!-- ================= SELECTOR DE CANTIDAD ================= -->
    {% if main_variant.stock > 0 %}
        <div id="quantityContainer" class="mb-3">
            <label class="fw-bold mb-2 d-block">Cantidad:</label>
            <select id="quantitySelect" class="form-select" style="width: 150px;">
                {% for i in main_variant.stock|range_list %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>
    {% else %}
        <div id="quantityContainer" class="mb-3"></div>
    {% endif %}

    <!-- ================= BOTONES DE COMPRA ================= -->
    <div id="cartButtonContainer" class="d-grid gap-2 mb-3">
        {% if main_variant.stock > 0 %}
            <!-- Botón principal - Contraentrega -->
            <button type="button" id="contraentregaBtn" class="btn bg-primary text-light w-100 fw-bold py-3 shadow-sm">
                <div class="d-flex flex-column align-items-center">
                    <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-truck fs-3 me-2"></i>
                        <span class="fs-4">¡Pedir Contraentrega!</span>
                    </div>
                    <small class="opacity-90">Envío gratis a todo el país</small>
                </div>
            </button>
            
            <!-- Botón secundario - Añadir al carrito -->
            <button type="button" id="addToCartBtn" class="btn bg-primary text-light w-100 fw-bold py-2 shadow-sm">
                <i class="bi bi-bag-plus fs-5 me-2"></i>
                <span class="fs-5">Añadir al carrito</span>
            </button>
        {% else %}
            <!-- Botón deshabilitado - Producto agotado -->
            <button class="btn btn-danger w-100 fw-bold py-3 shadow-sm" disabled>
                <i class="bi bi-x-circle fs-5 me-2"></i>
                <span class="fs-5">Producto agotado</span>
            </button>
        {% endif %}
        
    </div>

    

{% endif %}